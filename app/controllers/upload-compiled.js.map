{"version":3,"sources":["upload.js"],"names":[],"mappings":"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","file":"upload-compiled.js","sourcesContent":["import fs from 'fs';\nimport config from '../../config/config.js';\nimport path from 'path';\nimport express from 'express';\n\nimport multipart from 'connect-multiparty';\nlet router = express.Router(),\n  multipartMiddleware = multipart(),\n  db = null,\n  flow = null,\n  ACCESS_CONTROLL_ALLOW_ORIGIN = true;\n\nmodule.exports = function (app, createClient, Flow) {\n  app.use('/', router);\n  db = createClient();\n  flow = Flow;\n};\n\n// Handle uploads through Flow.js\nrouter.post('/upload', multipartMiddleware, function (req, res) {\n  flow.post(req, function (status, filename, original_filename, identifier) {\n    console.log('POST', status, original_filename, identifier);\n    if (ACCESS_CONTROLL_ALLOW_ORIGIN) {\n      res.header(\"Access-Control-Allow-Origin\", \"*\");\n    }\n    if (status === 'done') {\n      if (!config.useRiak) {\n        let destination = config.storageDir + '/' + identifier;\n        let writeFile = fs.createWriteStream(destination);\n        flow.write(identifier, writeFile);\n        writeFile.on('finish', function () {\n\n          flow.clean(identifier);\n        })\n      }\n    }\n    res.status(status).send();\n  });\n});\n\nrouter.options('/upload', function (req, res) {\n  console.log('OPTIONS');\n  if (ACCESS_CONTROLL_ALLOW_ORIGIN) {\n    res.header(\"Access-Control-Allow-Origin\", \"*\");\n  }\n  res.status(200).send();\n});\n\n// Handle status checks on chunks through Flow.js\nrouter.get('/upload', function (req, res) {\n  flow.get(req, function (status, filename, original_filename, identifier) {\n    console.log('GET', status);\n    if (ACCESS_CONTROLL_ALLOW_ORIGIN) {\n      res.header(\"Access-Control-Allow-Origin\", \"*\");\n    }\n\n    if (status == 'found') {\n      status = 200;\n    } else {\n      status = 204;\n    }\n\n    res.status(status).send();\n  });\n});\n\nrouter.get('/download/:identifier', function (req, res) {\n\n  if (!config.useRiak) {\n    res.status(200).sendFile(path.resolve(config.storageDir + '/' + req.params.identifier));\n  }\n\n});\n"]}